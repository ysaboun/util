WITH emails_en_doublon AS (
    SELECT
        e.eml_adresse
    FROM
        email e
    GROUP BY
        e.eml_adresse
    HAVING
        COUNT(DISTINCT e.eml_pers_id) > 1 -- Emails associés à plusieurs personnes physiques (doublons)
),
icm_avec_emails_en_doublon AS (
    SELECT
        c.cnx_icm,
        e.eml_adresse,
        e.eml_maj_dt
    FROM
        connexion c
    JOIN email e ON c.personne_physique_id = e.eml_pers_id
    WHERE
        e.eml_adresse IN (SELECT eml_adresse FROM emails_en_doublon) -- Filtre les emails en doublon
)
SELECT
    cnx_icm,
    COUNT(DISTINCT eml_adresse) AS nb_emails_en_doublon,
    COUNT(DISTINCT CASE WHEN eml_maj_dt >= ADD_MONTHS(SYSDATE, -12) THEN eml_adresse END) AS nb_emails_1_an,
    COUNT(DISTINCT CASE WHEN eml_maj_dt >= ADD_MONTHS(SYSDATE, -60) THEN eml_adresse END) AS nb_emails_5_ans
FROM
    icm_avec_emails_en_doublon
GROUP BY
    cnx_icm
ORDER BY
    nb_emails_en_doublon DESC;
