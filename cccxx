WITH mobiles_associes AS (
    SELECT
        c.cnx_icm,
        t.tel_numero,
        t.tel_maj_dt,
        COUNT(DISTINCT t.tel_numero) OVER (PARTITION BY c.cnx_icm) AS nb_mobiles
    FROM
        connexion c
    JOIN telephone_per t ON c.personne_physique_id = t.tel_pers_id
    WHERE
        t.tel_type_tid = 'MOBILE' -- Assurez-vous que cette valeur correspond au type "mobile" dans votre système
)
SELECT
    cnx_icm,
    nb_mobiles,
    COUNT(CASE WHEN tel_maj_dt >= ADD_MONTHS(SYSDATE, -12) THEN tel_numero END) AS nb_mobiles_1_an,
    COUNT(CASE WHEN tel_maj_dt >= ADD_MONTHS(SYSDATE, -60) THEN tel_numero END) AS nb_mobiles_5_ans
FROM
    mobiles_associes
WHERE
    nb_mobiles >= 1 -- Au moins un mobile associé
GROUP BY
    cnx_icm, nb_mobiles
HAVING
    COUNT(DISTINCT tel_numero) > 1 -- Au moins deux mobiles distincts
ORDER BY
    nb_mobiles DESC;
