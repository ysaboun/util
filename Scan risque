#!/bin/bash

# Configuration
DOMAIN="${1:-localhost:8080}"
PROTOCOL="${2:-http}"
BASE_URL="$PROTOCOL://$DOMAIN"

# Couleurs
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}üîç Scan de s√©curit√© Spring Boot - $BASE_URL${NC}"
echo "================================================"

check_endpoint() {
    local endpoint="$1"
    local description="$2"
    local url="$BASE_URL$endpoint"
    
    echo -n "Testing $endpoint ($description)... "
    
    response=$(curl -s -o /dev/null -w "%{http_code}" --connect-timeout 10 "$url")
    
    case $response in
        200|204)
            echo -e "${RED}‚ùå VULN√âRABLE ($response)${NC}"
            return 1
            ;;
        401|403)
            echo -e "${GREEN}‚úÖ S√âCURIS√â ($response - Authentification requise)${NC}"
            return 0
            ;;
        404)
            echo -e "${GREEN}‚úÖ S√âCURIS√â ($response - Non trouv√©)${NC}"
            return 0
            ;;
        000)
            echo -e "${YELLOW}‚ö†Ô∏è  INACCESSIBLE (Timeout/Connection refused)${NC}"
            return 2
            ;;
        *)
            echo -e "${YELLOW}‚ö†Ô∏è  CODE $response${NC}"
            return 2
            ;;
    esac
}

# Compteurs
vulnerable=0
secure=0
unknown=0

echo -e "\n${YELLOW}1. V√©rification DevTools...${NC}"
check_endpoint "/devtools/health" "Health DevTools" || ((vulnerable++))
check_endpoint "/devtools/restart" "Restart DevTools" || ((vulnerable++))
check_endpoint "/devtools/livereload" "LiveReload DevTools" || ((vulnerable++))
check_endpoint "/.~~spring-boot!~/restart" "Remote Restart" || ((vulnerable++))

echo -e "\n${YELLOW}2. V√©rification Actuator...${NC}"
check_endpoint "/actuator" "Actuator Root" || ((vulnerable++))
check_endpoint "/actuator/env" "Environment Variables" || ((vulnerable++))
check_endpoint "/actuator/beans" "Spring Beans" || ((vulnerable++))
check_endpoint "/actuator/configprops" "Configuration Properties" || ((vulnerable++))
check_endpoint "/actuator/mappings" "URL Mappings" || ((vulnerable++))
check_endpoint "/actuator/health" "Health Info" || ((secure++))
check_endpoint "/actuator/info" "App Info" || ((secure++))

echo -e "\n${YELLOW}3. V√©rification endpoints classiques...${NC}"
check_endpoint "/manage/health" "Management Health" || ((vulnerable++))
check_endpoint "/monitoring/health" "Monitoring Health" || ((vulnerable++))
check_endpoint "/api/health" "API Health" || ((vulnerable++))

echo -e "\n${YELLOW}4. V√©rification H2 Console (si utilis√©e)...${NC}"
check_endpoint "/h2-console" "H2 Database Console" || ((vulnerable++))

# R√©sum√©
echo "================================================"
echo -e "${YELLOW}üìä R√âSULTAT DU SCAN:${NC}"

if [ $vulnerable -eq 0 ]; then
    echo -e "${GREEN}‚úÖ TOUT EST S√âCURIS√â - Aucun endpoint sensible expos√©${NC}"
else
    echo -e "${RED}‚ùå $vulnerable ENDPOINT(S) VULN√âRABLE(S) D√âTECT√â(S)${NC}"
    echo -e "${YELLOW}üö® ACTION REQUISE: S√©curisez ces endpoints imm√©diatement!${NC}"
fi

echo -e "\n${YELLOW}üí° RECOMMANDATIONS:${NC}"
echo "1. D√©sactivez DevTools en production"
echo "2. Restreignez l'exposure d'Actuator: management.endpoints.web.exposure.include=health"
echo "3. Ajoutez une authentification sur les endpoints de management"
echo "4. Utilisez un r√©seau priv√© pour les endpoints sensibles"

exit $vulnerable
