-- =========================================================================
-- SCRIPT : export_csv.sql
-- OBJECTIF : Exporter un fichier CSV (s√©parateur ;) avec logs et stats
-- PR√âREQUIS : SQLcl (Oracle SQL Developer Command Line)
-- =========================================================================

-- ‚öôÔ∏è Configuration de l‚Äôenvironnement
SET ECHO OFF
SET FEEDBACK OFF
SET HEADING ON
SET PAGESIZE 0
SET LINESIZE 1000
SET TRIMSPOOL ON
SET COLSEP ';'
SET TERMOUT OFF
SET VERIFY OFF
SET DEFINE ON
SET TIMING OFF

-- üïí Timestamp pour noms de fichiers
COLUMN export_time NEW_VALUE export_time
SELECT TO_CHAR(SYSDATE, 'YYYYMMDD_HH24MISS') AS export_time FROM dual;

-- üïì Heure de d√©but (pour stats de dur√©e)
COLUMN start_time NEW_VALUE start_time
SELECT TO_CHAR(SYSTIMESTAMP, 'YYYY-MM-DD HH24:MI:SS.FF') AS start_time FROM dual;

-- üî¢ Compter le nombre de lignes pr√©vues
COLUMN nb_lignes NEW_VALUE nb_lignes
SELECT COUNT(*) AS nb_lignes
FROM emp e
JOIN dept d ON e.deptno = d.deptno;

-- üíæ Export CSV
SPOOL /chemin/vers/export_&export_time..csv

SELECT
    TRIM(e.empno),
    TRIM(e.ename),
    TRIM(e.job),
    TO_CHAR(e.hiredate, 'YYYY-MM-DD'),
    TRIM(e.sal),
    TRIM(d.dname)
FROM emp e
JOIN dept d ON e.deptno = d.deptno;

SPOOL OFF

-- üïì Heure de fin
COLUMN end_time NEW_VALUE end_time
SELECT TO_CHAR(SYSTIMESTAMP, 'YYYY-MM-DD HH24:MI:SS.FF') AS end_time FROM dual;

-- üßæ Log d‚Äôex√©cution
SPOOL /chemin/vers/export_&export_time..log

PROMPT === Export CSV termin√© ===
PROMPT Date et heure de d√©but : &start_time
PROMPT Date et heure de fin   : &end_time
PROMPT Nombre de lignes       : &nb_lignes
PROMPT Fichier CSV g√©n√©r√©     : export_&export_time..csv

SPOOL OFF

-- ‚úÖ Nettoyage
SET FEEDBACK ON
SET TERMOUT ON
